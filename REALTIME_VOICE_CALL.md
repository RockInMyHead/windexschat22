# üéôÔ∏è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –†–µ–∞–ª—Ç–∞–π–º –ì–æ–ª–æ—Å–æ–≤–æ–≥–æ –ó–≤–æ–Ω–∫–∞

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã](#–æ–±–∑–æ—Ä-—Å–∏—Å—Ç–µ–º—ã)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
3. [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã](#–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã-—Å–∏—Å—Ç–µ–º—ã)
4. [–ü—Ä–æ—Ç–æ–∫–æ–ª WebSocket](#–ø—Ä–æ—Ç–æ–∫–æ–ª-websocket)
5. [–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ](#–æ–±—Ä–∞–±–æ—Ç–∫–∞-–∞—É–¥–∏–æ)
6. [–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö](#–ø–æ—Ç–æ–∫-–¥–∞–Ω–Ω—ã—Ö)
7. [–ú–∞—à–∏–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π](#–º–∞—à–∏–Ω–∞-—Å–æ—Å—Ç–æ—è–Ω–∏–π)
8. [–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏](#—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ-–¥–µ—Ç–∞–ª–∏)

---

## üéØ –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ —Ä–µ–∞–ª—Ç–∞–π–º –≥–æ–ª–æ—Å–æ–≤—ã—Ö –∑–≤–æ–Ω–∫–æ–≤ WindexsAI –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç **–Ω–∏–∑–∫–æ–ª–∞—Ç–µ–Ω—Ç–Ω–æ–µ** (<500ms) –æ–±—â–µ–Ω–∏–µ —Å AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º —á–µ—Ä–µ–∑ –≥–æ–ª–æ—Å. –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:

- ‚úÖ **Real-time STT** (Speech-to-Text) - —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ **AI Responses** - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ DeepSeek LLM
- ‚úÖ **Real-time TTS** (Text-to-Speech) - —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ —Å –ø–æ—Ç–æ–∫–æ–≤–æ–π –ø–µ—Ä–µ–¥–∞—á–µ–π
- ‚úÖ **VAD** (Voice Activity Detection) - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- ‚úÖ **Barge-in** - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–±–∏—Ç—å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
- ‚úÖ **WebSocket** - –Ω–∏–∑–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –û–±—â–∞—è —Å—Ö–µ–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend      ‚îÇ
‚îÇ  (React/TS)     ‚îÇ
‚îÇ                 ‚îÇ
‚îÇ  VoiceCall.tsx  ‚îÇ
‚îÇ  AudioWorklet   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ WebSocket (ws:// –∏–ª–∏ wss://)
         ‚îÇ PCM Audio (binary)
         ‚îÇ JSON Events
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Nginx Proxy    ‚îÇ
‚îÇ  /ws-voice/     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  STT Backend    ‚îÇ
‚îÇ  (Python)       ‚îÇ
‚îÇ  Port: 2700     ‚îÇ
‚îÇ                 ‚îÇ
‚îÇ  server_fixed.py‚îÇ
‚îÇ  voice_pipeline ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îú‚îÄ‚îÄ‚ñ∫ Vosk (STT)
         ‚îú‚îÄ‚îÄ‚ñ∫ DeepSeek (LLM)
         ‚îî‚îÄ‚îÄ‚ñ∫ Silero (TTS)
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **Frontend** (`src/components/VoiceCall.tsx`)
   - React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è UI
   - WebSocket –∫–ª–∏–µ–Ω—Ç
   - AudioWorklet –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∑–≤–æ–Ω–∫–∞

2. **Nginx Proxy** (`/ws-voice/`)
   - –ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ wss:// –¥–ª—è HTTPS
   - –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –Ω–∞ –ø–æ—Ä—Ç 2700

3. **STT Backend** (`voice-backend/stt/server_fixed.py`)
   - WebSocket —Å–µ—Ä–≤–µ—Ä (–ø–æ—Ä—Ç 2700)
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Vosk –¥–ª—è STT
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å DeepSeek –¥–ª—è LLM
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Silero –¥–ª—è TTS
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏—è–º–∏ –∏ –¥–∏–∞–ª–æ–≥–∞–º–∏

4. **Voice Pipeline** (`voice-backend/stt/voice_pipeline.py`)
   - –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∏–∞–ª–æ–≥–∞
   - VAD –∏ endpointing
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
   - Barge-in –æ–±—Ä–∞–±–æ—Ç–∫–∞

---

## üîß –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 1. Frontend: VoiceCall.tsx

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `src/components/VoiceCall.tsx`

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**

#### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebSocket

```typescript
const wsUrl = window.location.protocol === 'https:' 
  ? `wss://${window.location.hostname}/ws-voice/`
  : `ws://${window.location.hostname}:2700`;
```

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ (ws:// –¥–ª—è HTTP, wss:// –¥–ª—è HTTPS)
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Nginx proxy –ø—Ä–∏ HTTPS

#### –ó–∞—Ö–≤–∞—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞

```typescript
const stream = await navigator.mediaDevices.getUserMedia({
  audio: {
    channelCount: 1,
    echoCancellation: true,
    noiseSuppression: true,
    autoGainControl: true,
    sampleRate: 16000
  }
});
```

- –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞: –º–æ–Ω–æ, 16kHz, —Å —à—É–º–æ–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ–º

#### AudioWorklet –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ PCM

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `public/audioWorklet.js`

**–§—É–Ω–∫—Ü–∏–∏:**
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è float32 ‚Üí int16 PCM
- –†–µ—Å–µ–º–ø–ª–∏–Ω–≥ –¥–æ 16kHz (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
- –†–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ —á–∞–Ω–∫–∏ –ø–æ 20ms (320 samples)
- –û—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ WebSocket

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. AudioWorklet –ø–æ–ª—É—á–∞–µ—Ç –∞—É–¥–∏–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ float32
2. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ int16 PCM
3. –†–µ—Å–µ–º–ø–ª–∏—Ç –¥–æ 16kHz
4. –ù–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç 320 samples (20ms)
5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ WebSocket

#### –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ

```typescript
// –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∏–Ω–∞—Ä–Ω—ã—Ö –∞—É–¥–∏–æ —á–∞–Ω–∫–æ–≤ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
ws.onmessage = (event) => {
  if (event.data instanceof ArrayBuffer) {
    // –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ WAV –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
    audioContext.decodeAudioData(event.data)
      .then(audioBuffer => playAudioChunk(audioBuffer));
  }
};
```

### 2. Backend: server_fixed.py

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `voice-backend/stt/server_fixed.py`

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**

#### Transport Layer (server_fixed.py)

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- WebSocket –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª
- Handshake –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
- –ë–∏–Ω–∞—Ä–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö
- –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ù–µ –∑–Ω–∞–µ—Ç –æ LLM, TTS –∏–ª–∏ Vosk
- –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –±–∞–π—Ç–∞–º–∏ –∏ JSON —Å–æ–±—ã—Ç–∏—è–º–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç callback'–∏ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –≤ Logic Layer

#### Logic Layer (voice_pipeline.py)

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
- –í–µ—Å—å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π —Ü–∏–∫–ª –¥–∏–∞–ª–æ–≥–∞
- VAD & ASR Processing
- Endpointing Logic
- LLM Invocation (DeepSeek)
- TTS Streaming (Silero)
- Barge-in Management
- Session Context

**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã:**

##### VoicePipeline

```python
class VoicePipeline:
    def __init__(
        self, 
        session_id: str,
        preset: dict,
        send_event: Callable[[dict], Any],
        send_audio: Callable[[int, bytes], Any],
        vad_engine: Any,
        recognizer: Any,
        sample_rate: int,
        protocol_version: int = 1
    ):
```

**–ú–µ—Ç–æ–¥—ã:**
- `process_pcm_frame()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ PCM –∫–∞–¥—Ä–æ–≤
- `handle_final_text()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –æ—Ç STT
- `call_llm()` - –≤—ã–∑–æ–≤ LLM –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞
- `synthesize_tts()` - —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ —á–µ—Ä–µ–∑ TTS

##### SessionState

```python
@dataclass
class SessionState:
    session_id: str
    turns: list[Turn] = field(default_factory=list)
    llm_buffers: dict[int, str] = field(default_factory=dict)
    summary: str = ""
    ended: bool = False
```

**–§—É–Ω–∫—Ü–∏–∏:**
- –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞
- –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è LLM
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ utterance_id –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### 3. STT: Vosk Integration

**–ú–æ–¥–µ–ª—å:** `vosk-model-small-ru-0.22`

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
from vosk import Model, KaldiRecognizer

MODEL = Model(MODEL_PATH)
rec = KaldiRecognizer(MODEL, sample_rate)
```

**–§—É–Ω–∫—Ü–∏–∏:**
- `AcceptWaveform()` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ PCM –∫–∞–¥—Ä–æ–≤
- `PartialResult()` - –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- `Result()` - —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- Sample rate: 16000 Hz
- Format: PCM 16-bit mono
- Frame size: 640 bytes (20ms @ 16kHz)

### 4. LLM: DeepSeek Integration

**API:** DeepSeek Chat Completions

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
async with httpx.AsyncClient() as client:
    response = await client.post(
        f"{LLM_BASE_URL}/v1/chat/completions",
        headers={"Authorization": f"Bearer {LLM_API_KEY}"},
        json={
            "model": "deepseek-chat",
            "messages": messages,
            "stream": True
        }
    )
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Streaming –æ—Ç–≤–µ—Ç—ã (SSE)
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞
- –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è

### 5. TTS: Silero Integration

**–ú–æ–¥–µ–ª—å:** Silero TTS (—Ä—É—Å—Å–∫–∏–π/–∞–Ω–≥–ª–∏–π—Å–∫–∏–π)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```python
import tts_silero

wav_bytes = await tts_silero.synthesize_wav(
    text=text,
    model_name="silero_ru",
    voice="eugene",
    speed=0.93,
    emotion="neutral"
)
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ (–±–µ–∑ HTTP)
- –ü–æ—Ç–æ–∫–æ–≤–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ —á–∞–Ω–∫–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —ç–º–æ—Ü–∏–π –∏ —Å–∫–æ—Ä–æ—Å—Ç–∏

---

## üì° –ü—Ä–æ—Ç–æ–∫–æ–ª WebSocket

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

**URL:**
- HTTP: `ws://hostname:2700`
- HTTPS: `wss://hostname/ws-voice/` (—á–µ—Ä–µ–∑ Nginx)

**Handshake:**
1. –ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ WebSocket
2. –°–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–±—ã—Ç–∏–µ `ready`:
```json
{
  "event": "ready",
  "sample_rate": 16000,
  "frame_ms": 20,
  "vad_mode": 2,
  "early_pause_ms": 300,
  "protocol_version": 2
}
```

### –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏–π

#### 1. –û—Ç –∫–ª–∏–µ–Ω—Ç–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É

**–ë–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (PCM):**
- –§–æ—Ä–º–∞—Ç: PCM 16-bit mono, 16kHz
- –†–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞: 640 bytes (20ms)
- –ß–∞—Å—Ç–æ—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: –∫–∞–∂–¥—ã–µ 20ms

**JSON —Å–æ–±—ã—Ç–∏—è:**
```json
{
  "type": "ping"
}
```

#### 2. –û—Ç —Å–µ—Ä–≤–µ—Ä–∞ –∫ –∫–ª–∏–µ–Ω—Ç—É

**JSON —Å–æ–±—ã—Ç–∏—è:**

##### `ready` - —Å–µ—Ä–≤–µ—Ä –≥–æ—Ç–æ–≤
```json
{
  "event": "ready",
  "sample_rate": 16000,
  "frame_ms": 20,
  "vad_mode": 2,
  "early_pause_ms": 300,
  "protocol_version": 2
}
```

##### `partial` - –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç STT
```json
{
  "type": "partial",
  "text": "–ø—Ä–∏–≤–µ—Ç –∫–∞–∫"
}
```

##### `final` - —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç STT
```json
{
  "type": "final",
  "text": "–ø—Ä–∏–≤–µ—Ç –∫–∞–∫ –¥–µ–ª–∞"
}
```

##### `llm_start` - –Ω–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞
```json
{
  "type": "llm_start"
}
```

##### `llm_delta` - –ø–æ—Ç–æ–∫–æ–≤—ã–µ —á–∞–Ω–∫–∏ –æ—Ç–≤–µ—Ç–∞
```json
{
  "type": "llm_delta",
  "delta": "–ü—Ä–∏–≤–µ—Ç"
}
```

##### `llm_end` - –∫–æ–Ω–µ—Ü –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
```json
{
  "type": "llm_end"
}
```

##### `tts_start` - –Ω–∞—á–∞–ª–æ —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏
```json
{
  "type": "tts_start",
  "utterance_id": 1
}
```

##### `tts_audio` - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –∞—É–¥–∏–æ
```json
{
  "type": "tts_audio",
  "utterance_id": 1,
  "mime": "audio/wav"
}
```

##### `tts_end` - –∫–æ–Ω–µ—Ü —Å–∏–Ω—Ç–µ–∑–∞
```json
{
  "type": "tts_end",
  "utterance_id": 1
}
```

**–ë–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–∞—É–¥–∏–æ):**
- –§–æ—Ä–º–∞—Ç: WAV —Ñ–∞–π–ª—ã
- –û—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –º–µ–∂–¥—É `tts_start` –∏ `tts_end`
- –†–∞–∑–º–µ—Ä: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–π (–ø–æ–ª–Ω—ã–µ WAV —á–∞–Ω–∫–∏)

---

## üéµ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ

### Frontend: AudioWorklet

**–§–∞–π–ª:** `public/audioWorklet.js`

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∞—É–¥–∏–æ –æ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:**
   ```javascript
   const source = audioContext.createMediaStreamSource(stream);
   source.connect(workletNode);
   ```

2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ AudioWorklet:**
   - –í—Ö–æ–¥: float32 samples (128 samples –∑–∞ –∫–≤–∞–Ω—Ç)
   - –†–µ—Å–µ–º–ø–ª–∏–Ω–≥ –¥–æ 16kHz (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
   - –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è float32 ‚Üí int16
   - –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –¥–æ 320 samples (20ms)

3. **–û—Ç–ø—Ä–∞–≤–∫–∞ PCM:**
   ```javascript
   workletNode.port.onmessage = (event) => {
     const { pcm } = event.data;
     ws.send(pcm); // Int16Array buffer
   };
   ```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- Input: float32, –ª—é–±–æ–π sample rate
- Output: int16 PCM, 16kHz mono
- Chunk size: 320 samples = 20ms @ 16kHz

### Backend: –û–±—Ä–∞–±–æ—Ç–∫–∞ PCM

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ PCM –∫–∞–¥—Ä–æ–≤:**
   ```python
   async def handle_websocket(websocket):
       async for message in websocket:
           if isinstance(message, bytes):
               # PCM –¥–∞–Ω–Ω—ã–µ
               await pipeline.process_pcm_frame(message)
   ```

2. **VAD (Voice Activity Detection):**
   ```python
   is_speech = vad.is_speech(frame, sample_rate)
   ```

3. **STT –æ–±—Ä–∞–±–æ—Ç–∫–∞:**
   ```python
   if rec.AcceptWaveform(frame):
       final_text = json.loads(rec.Result())["text"]
   else:
       partial_text = json.loads(rec.PartialResult())["partial"]
   ```

4. **Endpointing:**
   - Early pause detection (300ms)
   - Final pause detection (800ms)
   - –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Ñ—Ä–∞–∑—ã

---

## üîÑ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

### –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –¥–∏–∞–ª–æ–≥–∞

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç
   ‚îÇ
   ‚ñº
2. –ú–∏–∫—Ä–æ—Ñ–æ–Ω ‚Üí AudioWorklet ‚Üí PCM (20ms chunks)
   ‚îÇ
   ‚ñº
3. WebSocket ‚Üí STT Backend
   ‚îÇ
   ‚ñº
4. Vosk STT ‚Üí partial/final —Ç–µ–∫—Å—Ç
   ‚îÇ
   ‚ñº
5. Endpointing ‚Üí —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
   ‚îÇ
   ‚ñº
6. DeepSeek LLM ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ (streaming)
   ‚îÇ
   ‚ñº
7. Silero TTS ‚Üí —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏ (WAV chunks)
   ‚îÇ
   ‚ñº
8. WebSocket ‚Üí Frontend ‚Üí –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
   ‚îÇ
   ‚ñº
9. –¶–∏–∫–ª –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è
```

### –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫

#### –≠—Ç–∞–ø 1: –ó–∞—Ö–≤–∞—Ç —Ä–µ—á–∏

```
[–ú–∏–∫—Ä–æ—Ñ–æ–Ω]
    ‚îÇ
    ‚ñº float32, 48kHz (–∏–ª–∏ –¥—Ä—É–≥–æ–π)
[AudioWorklet]
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ –†–µ—Å–µ–º–ø–ª–∏–Ω–≥ ‚Üí 16kHz
    ‚îú‚îÄ‚ñ∫ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è ‚Üí int16
    ‚îî‚îÄ‚ñ∫ –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ ‚Üí 320 samples (20ms)
    ‚îÇ
    ‚ñº Int16Array (640 bytes)
[WebSocket.send()]
```

#### –≠—Ç–∞–ø 2: –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏

```
[WebSocket receive PCM]
    ‚îÇ
    ‚ñº 640 bytes (20ms)
[VAD Engine]
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ is_speech? ‚Üí True/False
    ‚îî‚îÄ‚ñ∫ VAD state update
    ‚îÇ
    ‚ñº
[Vosk Recognizer]
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ AcceptWaveform() ‚Üí final result
    ‚îî‚îÄ‚ñ∫ PartialResult() ‚Üí partial text
    ‚îÇ
    ‚ñº
[Endpointing Logic]
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ Early pause? ‚Üí early endpoint
    ‚îú‚îÄ‚ñ∫ Final pause? ‚Üí final endpoint
    ‚îî‚îÄ‚ñ∫ Stable text? ‚Üí send final
    ‚îÇ
    ‚ñº "–ø—Ä–∏–≤–µ—Ç –∫–∞–∫ –¥–µ–ª–∞"
[Send final event]
```

#### –≠—Ç–∞–ø 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞

```
[Final text received]
    ‚îÇ
    ‚ñº
[SessionState.add_turn("user", text)]
    ‚îÇ
    ‚ñº
[Build LLM messages]
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ System prompt
    ‚îú‚îÄ‚ñ∫ History (last 12 turns)
    ‚îî‚îÄ‚ñ∫ Current user message
    ‚îÇ
    ‚ñº
[DeepSeek API call]
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ POST /v1/chat/completions
    ‚îú‚îÄ‚ñ∫ stream: true
    ‚îî‚îÄ‚ñ∫ SSE response
    ‚îÇ
    ‚ñº Streaming deltas
[Process LLM stream]
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ llm_start event
    ‚îú‚îÄ‚ñ∫ llm_delta events (chunks)
    ‚îî‚îÄ‚ñ∫ llm_end event
    ‚îÇ
    ‚ñº "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?"
[TTS Synthesis]
```

#### –≠—Ç–∞–ø 4: –°–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏

```
[LLM response text]
    ‚îÇ
    ‚ñº
[Silero TTS]
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ synthesize_wav()
    ‚îú‚îÄ‚ñ∫ Text ‚Üí WAV bytes
    ‚îî‚îÄ‚ñ∫ Split into chunks
    ‚îÇ
    ‚ñº WAV chunks
[Send audio]
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ tts_start event
    ‚îú‚îÄ‚ñ∫ tts_audio metadata
    ‚îú‚îÄ‚ñ∫ Binary WAV chunks
    ‚îî‚îÄ‚ñ∫ tts_end event
    ‚îÇ
    ‚ñº
[Frontend playback]
```

---

## üéõÔ∏è –ú–∞—à–∏–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π

### VoiceState

```python
class VoiceState(Enum):
    IDLE = "idle"              # –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    USER_SPEAKING = "user"     # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç
    ASSISTANT_TTS = "tts"      # –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –≥–æ–≤–æ—Ä–∏—Ç
```

### –ü–µ—Ä–µ—Ö–æ–¥—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π

```
IDLE
  ‚îÇ
  ‚îÇ (partial text detected)
  ‚ñº
USER_SPEAKING
  ‚îÇ
  ‚îÇ (final text + endpoint)
  ‚ñº
[LLM Processing]
  ‚îÇ
  ‚îÇ (TTS starts)
  ‚ñº
ASSISTANT_TTS
  ‚îÇ
  ‚îÇ (TTS ends)
  ‚ñº
IDLE (loop)
```

### –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤

#### IDLE ‚Üí USER_SPEAKING

**–£—Å–ª–æ–≤–∏–µ:**
- –ü–æ–ª—É—á–µ–Ω partial —Ç–µ–∫—Å—Ç –æ—Ç STT
- VAD –æ–ø—Ä–µ–¥–µ–ª–∏–ª —Ä–µ—á—å

**–î–µ–π—Å—Ç–≤–∏—è:**
- `voice_state = VoiceState.USER_SPEAKING`
- –û—Ç–ø—Ä–∞–≤–∫–∞ `partial` —Å–æ–±—ã—Ç–∏—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
- –ê–∫—Ç–∏–≤–∞—Ü–∏—è endpointing –ª–æ–≥–∏–∫–∏

#### USER_SPEAKING ‚Üí ASSISTANT_TTS

**–£—Å–ª–æ–≤–∏–µ:**
- –ü–æ–ª—É—á–µ–Ω final —Ç–µ–∫—Å—Ç
- Endpointing –æ–ø—Ä–µ–¥–µ–ª–∏–ª –∫–æ–Ω–µ—Ü —Ñ—Ä–∞–∑—ã
- LLM —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª –æ—Ç–≤–µ—Ç
- TTS –Ω–∞—á–∞–ª —Å–∏–Ω—Ç–µ–∑

**–î–µ–π—Å—Ç–≤–∏—è:**
- `voice_state = VoiceState.ASSISTANT_TTS`
- –û—Ç–ø—Ä–∞–≤–∫–∞ `tts_start` —Å–æ–±—ã—Ç–∏—è
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏–µ–º–∞ PCM (barge-in protection)

#### ASSISTANT_TTS ‚Üí IDLE

**–£—Å–ª–æ–≤–∏–µ:**
- TTS –∑–∞–≤–µ—Ä—à–∏–ª —Å–∏–Ω—Ç–µ–∑
- –í—Å–µ –∞—É–¥–∏–æ —á–∞–Ω–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã

**–î–µ–π—Å—Ç–≤–∏—è:**
- `voice_state = VoiceState.IDLE`
- –û—Ç–ø—Ä–∞–≤–∫–∞ `tts_end` —Å–æ–±—ã—Ç–∏—è
- –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏–µ–º–∞ PCM
- ASR warmup (200ms)

---

## ‚öôÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∞—É–¥–∏–æ

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| Sample Rate | 16000 Hz | –ß–∞—Å—Ç–æ—Ç–∞ –¥–∏—Å–∫—Ä–µ—Ç–∏–∑–∞—Ü–∏–∏ |
| Bit Depth | 16-bit | –†–∞–∑—Ä—è–¥–Ω–æ—Å—Ç—å PCM |
| Channels | Mono (1) | –ú–æ–Ω–æ –∫–∞–Ω–∞–ª |
| Frame Size | 640 bytes | 20ms @ 16kHz |
| Format | PCM | –ù–µ—Å–∂–∞—Ç—ã–π —Ñ–æ—Ä–º–∞—Ç |

### VAD –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| VAD Mode | 2 | –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ—Å—Ç—å (0-3) |
| Frame MS | 20ms | –†–∞–∑–º–µ—Ä –∫–∞–¥—Ä–∞ |
| Early Pause | 300ms | –†–∞–Ω–Ω–µ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—É–∑—ã |
| Final Pause | 800ms | –§–∏–Ω–∞–ª—å–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–∞—É–∑—ã |
| Stable MS | 250ms | –í—Ä–µ–º—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞ |

### Endpointing –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| MIN_WORDS_EARLY | 1 | –ú–∏–Ω–∏–º—É–º —Å–ª–æ–≤ –¥–ª—è early endpoint |
| MIN_CHARS_EARLY | 3 | –ú–∏–Ω–∏–º—É–º —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è early endpoint |
| RESTART_DEBOUNCE | 200ms | –ó–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º ASR |

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|----------|
| STT Latency | <500ms | –ó–∞–¥–µ—Ä–∂–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è |
| LLM Latency | <2s | –ó–∞–¥–µ—Ä–∂–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ |
| TTS Latency | <1s | –ó–∞–¥–µ—Ä–∂–∫–∞ —Å–∏–Ω—Ç–µ–∑–∞ |
| Total Latency | <3.5s | –ü–æ–ª–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —Ü–∏–∫–ª–∞ |
| Concurrent Users | 10-50 | –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ |

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **HTTPS/WSS –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω** –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
2. **JWT —Ç–æ–∫–µ–Ω—ã** –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
3. **Session isolation** - –∫–∞–∂–¥–∞—è —Å–µ—Å—Å–∏—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–∞
4. **Rate limiting** - –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

1. **WebSocket reconnection** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
2. **LLM fallback** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ API
3. **TTS fallback** - —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —Å–∏–Ω—Ç–µ–∑
4. **Graceful degradation** - –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

---

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### Frontend: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤–æ–Ω–∫–∞

```typescript
<VoiceCall
  wsUrl="wss://testchat.tartihome.ru/ws-voice/"
  onTranscript={(text, isFinal) => {
    console.log('Transcript:', text, isFinal);
  }}
  onLLMResponse={(delta, isStart, isEnd) => {
    console.log('LLM:', delta, isStart, isEnd);
  }}
  autoStart={false}
/>
```

### Backend: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–µ—Å—Å–∏–∏

```python
# –°–æ–∑–¥–∞–Ω–∏–µ pipeline –¥–ª—è —Å–µ—Å—Å–∏–∏
pipeline = VoicePipeline(
    session_id="session_123",
    preset=AGENTS["default"],
    send_event=send_event_callback,
    send_audio=send_audio_callback,
    vad_engine=vad,
    recognizer=rec,
    sample_rate=16000
)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ PCM –∫–∞–¥—Ä–æ–≤
await pipeline.process_pcm_frame(pcm_data)
```

---

## üîç –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**Frontend:**
- `üîå WebSocket connected` - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
- `üì§ Sending PCM` - –æ—Ç–ø—Ä–∞–≤–∫–∞ PCM –¥–∞–Ω–Ω—ã—Ö
- `üì® Received message` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è

**Backend:**
- `[STATE]` - –ø–µ—Ä–µ—Ö–æ–¥—ã —Å–æ—Å—Ç–æ—è–Ω–∏–π
- `[ASR]` - —Å–æ–±—ã—Ç–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
- `[LLM]` - —Å–æ–±—ã—Ç–∏—è LLM
- `[TTS]` - —Å–æ–±—ã—Ç–∏—è TTS

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ WebSocket —Å–µ—Ä–≤–µ—Ä–∞
curl -i -N -H "Connection: Upgrade" \
  -H "Upgrade: websocket" \
  -H "Sec-WebSocket-Key: test" \
  http://localhost:2700
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```python
# –ú–µ—Ç—Ä–∏–∫–∏ –≤ –ª–æ–≥–∞—Ö
- Latency: STT, LLM, TTS
- Throughput: frames/sec
- Error rate: failed requests
```

---

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.10+
- Node.js 20+
- Vosk –º–æ–¥–µ–ª—å (vosk-model-small-ru-0.22)
- Silero TTS (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞)
- DeepSeek API –∫–ª—é—á

### –ó–∞–ø—É—Å–∫

```bash
# 1. –ó–∞–ø—É—Å–∫ STT Backend
cd voice-backend/stt
python3 server_fixed.py

# 2. –ó–∞–ø—É—Å–∫ Frontend
npm run dev

# 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx (–¥–ª—è HTTPS)
sudo certbot --nginx -d testchat.tartihome.ru
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Vosk Models](https://alphacephei.com/vosk/models)
- [Silero TTS](https://github.com/snakers4/silero-models)
- [DeepSeek API](https://platform.deepseek.com/api-docs/)
- [WebSocket API](https://developer.mozilla.org/en-US/docs/Web/API/WebSocket)
- [AudioWorklet API](https://developer.mozilla.org/en-US/docs/Web/API/AudioWorklet)

---

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0  
**–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2026-01-25  
**–ê–≤—Ç–æ—Ä:** WindexsAI Development Team
